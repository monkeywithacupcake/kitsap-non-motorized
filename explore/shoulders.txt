# explore shoulders data

library(tidyverse)
library(sf)


# read in data
shoulders <- sf::read_sf("./data/KitsapShapefiles03_04_2022/SHOULDERS")
colnames(shoulders)
#[1] "ROAD_LOG_I" "BMP"        "EMP"        "ROAD_NAME"  "DISTANCE_M" "DISTANCE_F" "SIDE_OF_RO"
#[8] "SEG_ID"     "COMPOSITE_" "SHLDR_SURF" "SHLDR_WIDT" "MODIFIED_B" "MODIFIED_D" "CREATED_BY"
#[15] "CREATED_DT" "DISTRICT"   "DIST_SECTI" "CRIT_AREA"  "SHAPE_LEN"  "geometry" 

# build a dictionary backwards
shoulders_dict <- data.frame(col = colnames(shoulders),
                             def = c("Road Log Id - from Public Works?",
                                     "Beginning Mile Point",
                                     "Ending Mile Point",
                                     "Name used for road",
                                     "Distance of segment, in Miles",
                                     "Distance of segment, in Feet",
                                     "Side of road shoulder desc for",
                                     "Unique ID for Road Segment",
                                     "?",
                                     "Surface material of shoulder",
                                     "Width of shoulder surface",
                                     "who modified data",
                                     "date of modification of data",
                                     "who created data",
                                     "date of creation of data",
                                     "Commissioner District",
                                     "?",
                                     "?",
                                     "",
                                     "MULTILINESTRING geometry"),
                             vals = apply(shoulders, 2, function(x) ifelse(n_distinct(x) > 10, "many", paste(unique(x), collapse = ", "))) %>% as.vector()
                             )


plot(shoulders) 
# plots first 10 attributes with geometry

by_dist_road_side <- shoulders %>% 
  st_set_geometry(., NULL) %>%  # we don't need to keep the geometry here
  group_by(DISTRICT, ROAD_NAME, SIDE_OF_RO, SHLDR_WIDT) %>%
  summarise(LINEAR_FEET = sum(DISTANCE_F, na.rm=TRUE), 
            .groups = "drop") %>%
  filter(!is.na(SIDE_OF_RO), !is.na(SHLDR_WIDT)) %>% # should not include
  mutate(SIDE_OF_RO = recode(SIDE_OF_RO,
                             "Left" = "LEFT",
                             .default = SIDE_OF_RO))

by_dist_road_side %>% 
  group_by(DISTRICT, ROAD_NAME) %>%
  summarise(n = n())

by_dist_road_distance <- by_dist_road_side %>%
  pivot_wider(names_from = "SIDE_OF_RO", values_from = "SHLDR_WIDT"
              )



roadcl <- sf::read_sf("./data/roadcl")

roadcl_shoulders <- st_snap(shoulders, roadcl, tolerance = 0.1)